# Markdown Math Fixer (Markdown 公式自动标准化工具)

## 📖 项目简介

**Markdown Math Fixer** 是一个轻量级的 Python 脚本，旨在辅助撰写包含大量数学公式的 Markdown 技术文档（如 SLAM、深度学习、控制理论笔记）。

它可以自动识别文本中的数学变量（如 $x_{k-1}$, $u_k$, 矩阵 $P$ 等）和公式，并自动为其添加 LaTeX 分隔符 `$`。同时，它专门针对 **MkDocs** 等静态网站生成器进行了优化，确保行内公式格式规范（去除首尾空格），防止渲染失败。

## 🚀 为什么开发这个工具？(Motivation)

在编写数学或工程类文档时，我们经常面临以下痛点：

1.  **重复劳动**：在书写行内公式时，频繁键入 `$` 符号打断思路，效率低下。
2.  **渲染兼容性**：MkDocs（配合 MathJax/KaTeX）对空格非常敏感。`$ x $` 往往无法渲染，必须严格写成 `$x$`。手动检查这些空格非常耗时。
3.  **误操作风险**：简单的查找替换容易破坏代码块（Code Blocks）或已有的块级公式（Display Math `$$...$$`）。

这个工具通过“**高亮审查 -> 一键清洗**”的工作流，完美解决了上述问题。

## ✨ 核心功能

-   **智能识别**：利用正则表达式和白名单机制，自动识别复杂的数学符号（如 `x_{k-1}`）和常用数学变量（如 `k`, `x`, `P`）。
-   **审查模式 (Highlight)**：不直接修改，而是将疑似公式加上 `$` 并用高亮语法 `==...==` 包裹，方便在编辑器中快速人工Review。
-   **MkDocs 兼容修复**：自动扫描所有行内公式，去除 `$ ` 和 ` $` 之间的空格（例如：自动将 `$ x $` 修复为 `$x$`）。
-   **智能保护**：严格跳过代码块 (````...````)、行内代码 (`     `...`     `) 和块级公式 (`$$...$$`)，只处理正文。
-   **回退机制 (Undo)**：支持一键撤销高亮状态下的所有修改。

## 🛠️ 环境要求

-   Python 3.x
-   无第三方依赖库（仅使用标准库 `re`, `argparse`, `pathlib`）

## 📦 使用教程

### 1. 准备工作

确保你的文件结构如下（参考截图）：

Plaintext

```
.
├── md_math_fixer.py    # 核心脚本
├── README.md           # 说明文档
└── your_note.md        # 你需要处理的 Markdown 笔记
```

### 2. 标准工作流 (Workflow)

建议按照以下三个步骤操作，以确保文档准确性。

#### 第一步：自动标注 (Highlight Mode)

运行脚本，脚本会识别公式，添加 `$`，并加上高亮标记 `==`。同时会自动修复已有的不规范空格。

Bash

```
python md_math_fixer.py your_note.md --mode highlight
```

>   **效果示例：**
>
>   -   原文本：`此时状态 x_{k-1} 和输入 u_k 决定了...`
>   -   处理后：`此时状态 ==$x_{k-1}$== 和输入 ==$u_k$== 决定了...`

#### 第二步：人工审查 (Review)

使用 VS Code、Typora 或 Obsidian 打开 `your_note.md`。

-   浏览文档，查看黄色高亮部分。
-   如果脚本误判（例如把英文单词 `a` 标为了公式），直接手动删除 `==$a$==` 改回 `a`。
-   如果脚本漏标，可以手动补上。

#### 第三步：一键清洗 (Clean Mode)

审查无误后，运行清洗模式。这会移除所有 `==` 高亮标记，保留 `$`，并再次确保格式紧凑。

Bash

```
python md_math_fixer.py your_note.md --mode clean
```

>   最终效果：
>
>   此时状态 $x_{k-1}$ 和输入 $u_k$ 决定了...

### 3. 撤销修改 (Undo Mode)

如果在 **Highlight** 阶段发现改动太乱，想放弃本次修改，可以使用 Undo 模式回退（前提是还没运行 Clean）。

Bash

```
python md_math_fixer.py your_note.md --mode undo
```

## ⚙️ 自定义配置

你可以打开 `md_math_fixer.py` 文件顶部，根据你的学科背景调整以下集合：

Python

```
# 1. 强制识别为公式的单字母变量（例如卡尔曼滤波常用矩阵）
MATH_VARS = set([
    'x', 'y', 'z', 'u', 'v', 'w', 
    'A', 'B', 'P', 'Q', 'R', 'K', 'H', # 矩阵
    'theta', 'alpha', 'beta' # 希腊字母
    # ... 按需添加
])

# 2. 强制排除的英文单词（避免误伤）
ENGLISH_STOPWORDS = set([
    'a', 'A', 'I', 'in', 'is', 'at', 'slam', 'map', 'update'
    # ... 按需添加
])
```

## ⚠️ 注意事项

1.  **备份文件**：虽然脚本有保护机制，但在处理重要文档前，建议先备份一份。
2.  **Display Math**：脚本已针对 `$$...$$` 换行公式做了保护，但建议你的 LaTeX 语法尽量标准。
3.  **英文单词误伤**：脚本使用白名单机制识别单字母变量，但对于 `I` (Identity Matrix vs I am) 或 `a` (Acceleration vs a book) 这样的词，仍需人工在 Highlight 阶段留意。

## 🤝 贡献

如果你有更好的正则表达式优化方案，或者针对特定领域（如量子力学、生物统计）的变量库，欢迎提交 PR！

## 📄 License

MIT License